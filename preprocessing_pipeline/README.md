# ElevenLabs Audio Content Preprocessing Pipeline

## Overview

This preprocessing pipeline converts ElevenLabs TTS output with character-level timing data into an enhanced JSON format optimized for the Audio Learning App's dual-level word and sentence highlighting system.

## Key Features

- **Character-to-Word Conversion**: Transforms character-level timing arrays into word-level timing data
- **Sentence Detection**: Automatically identifies sentence boundaries based on punctuation
- **Continuous Coverage**: Ensures no timing gaps between sentences for smooth highlighting
- **Paragraph Preservation**: Maintains original text formatting with paragraph breaks
- **Field Name Consistency**: Outputs snake_case JSON fields matching Flutter app expectations

## Input Files

### 1. ElevenLabs TTS Output (`*.json`)
Generated by ElevenLabs API with character-level timing:
```json
{
  "alignment": {
    "characters": ["T", "h", "e", " ", "o", "b", "j", "e", "c", "t", "i", "v", "e", ...],
    "character_start_times_seconds": [0.0, 0.058, 0.093, ...],
    "character_end_times_seconds": [0.058, 0.093, 0.116, ...]
  }
}
```

### 2. Original Content (Optional) (`original_content.json`)
Contains the source text with formatting:
```json
{
  "full_text": "The objective of this lesson is...\nLet's begin.\nInsurance is...",
  "paragraphs": ["The objective...", "Let's begin.", ...],
  "metadata": {...}
}
```

## Output Schema

### Enhanced Content JSON (`content.json`)
```json
{
  "version": "1.0",
  "source": "elevenlabs-complete",
  "displayText": "Full text with\nparagraph breaks preserved",
  "paragraphs": [
    "The objective of this lesson is to illustrate...",
    "Let's begin.",
    "Insurance is a vital component..."
  ],
  "headers": ["The Effect of Insurance", "Perception versus Reality", ...],
  "formatting": {
    "boldHeaders": false,
    "paragraphSpacing": true
  },
  "metadata": {
    "wordCount": 2347,
    "characterCount": 15407,
    "estimatedReadingTime": "11 minutes",
    "language": "en"
  },
  "timing": {
    "words": [
      {
        "word": "The",
        "start_ms": 0,
        "end_ms": 116,
        "char_start": 0,
        "char_end": 3,
        "sentence_index": 0
      },
      ...
    ],
    "sentences": [
      {
        "text": "The objective of this lesson is to illustrate...",
        "start_ms": 0,
        "end_ms": 4535,
        "sentence_index": 0,
        "wordStartIndex": 0,
        "wordEndIndex": 14,
        "char_start": 0,
        "char_end": 95
      },
      ...
    ],
    "totalDurationMs": 957646
  }
}
```

## Field Definitions

### Top-Level Fields
- `version`: Schema version for future compatibility
- `source`: Identifies preprocessing pipeline used
- `displayText`: Full text with newline characters for paragraph breaks
- `paragraphs`: Array of paragraph strings for structured display
- `headers`: Detected section headers from the content
- `formatting`: Display preferences for the app
- `metadata`: Content statistics and information
- `timing`: Synchronization data for audio playback

### Word Timing Object
- `word`: The word text
- `start_ms`: Start time in milliseconds
- `end_ms`: End time in milliseconds
- `char_start`: Character position in original text
- `char_end`: Character end position
- `sentence_index`: Which sentence this word belongs to (0-based)

### Sentence Timing Object
- `text`: Full sentence text
- `start_ms`: Sentence start time (extended for continuous coverage)
- `end_ms`: Sentence end time (extended for continuous coverage)
- `sentence_index`: Unique sentence identifier
- `wordStartIndex`: First word index in this sentence
- `wordEndIndex`: Last word index in this sentence
- `char_start`: Character position in text
- `char_end`: Character end position

## Key Algorithms

### 1. Word Extraction
Combines consecutive non-whitespace characters from the character array into words, tracking timing boundaries.

### 2. Sentence Detection
Identifies sentence boundaries based on:
- Sentence-ending punctuation (. ! ?)
- Special case handling for abbreviations (Dr., Mr., etc.)
- Context awareness for proper sentence breaks

### 3. Continuous Coverage Algorithm
Eliminates timing gaps between sentences:
1. Calculates midpoint between adjacent sentences
2. Extends current sentence end to midpoint
3. Starts next sentence from midpoint
4. Ensures every millisecond is covered by exactly one sentence

### 4. Paragraph Preservation
- Uses original content's newline characters if available
- Falls back to text analysis for paragraph detection
- Preserves formatting in displayText field

## Usage

### Basic Processing
```bash
python process_elevenlabs_complete.py "path/to/elevenlabs.json"
```

### With Original Content Verification
```bash
python process_elevenlabs_complete.py "elevenlabs.json" -c "original_content.json" -o "output.json"
```

### Command-Line Options
- First argument: Path to ElevenLabs JSON (required)
- `-o, --output`: Output path for enhanced JSON
- `-c, --original-content`: Path to original content for formatting preservation

## Flutter App Integration

The preprocessing ensures field names match the Flutter app's expectations:

```dart
// word_timing.dart expects:
factory WordTiming.fromJson(Map<String, dynamic> json) {
  return WordTiming(
    word: json['word'] as String,
    startMs: json['start_ms'] as int,      // snake_case
    endMs: json['end_ms'] as int,          // snake_case
    sentenceIndex: json['sentence_index'] as int? ?? 0,  // snake_case
    charStart: json['char_start'] as int?,
    charEnd: json['char_end'] as int?,
  );
}
```

## Benefits

1. **Perfect Synchronization**: No sentence highlighting flashing due to continuous coverage
2. **Preserved Formatting**: Maintains paragraph structure from original content
3. **Optimized Performance**: Pre-computed timing eliminates runtime calculations
4. **Consistent Field Names**: Snake_case throughout for Flutter compatibility
5. **Rich Metadata**: Includes word count, reading time, and structure information

## Validation

The script includes validation to ensure:
- No words have invalid sentence indices
- Sentences have no timing gaps
- Text matches original content (if provided)
- All field names use snake_case convention

## Example Output Summary

For a 16-minute audio file:
- 2,347 words processed
- 116 sentences detected
- 78 paragraphs preserved
- 15,407 characters
- 100% timing coverage (no gaps)
- 0 invalid sentence indices